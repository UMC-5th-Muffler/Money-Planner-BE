# 1 워크플로의 이름 지정
name: build-test

# 2 워크플로가 시작될 조건 지정
on:
  pull_request:
    branches: [ develop ]
jobs:
  build:
    runs-on: ubuntu-22.04 # 3 실행 환경 지정
    #4 실행스텝지정
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'corretto'
          java-version: '11'

      - name: Generate Envirvonment Variables File for Production
        run: |
          echo "DB_URL=$DB_URL" >> .env
          echo "DB_USERNAME=$DB_USERNAME" >> .env
          echo "DB_PASSWORD=$DB_PASSWORD" >> .env
          echo "DB_DLL_MODE=$DB_DLL_MODE" >> .env
          echo "JWT_SECRET=$JWT_SECRET" >> .env
          echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
          echo "KAKAO_CLIENT_ID=$KAKAO_OAUTH_CLIENT_ID" >> .env
          echo "KAKAO_REDIRECT_URI= $KAKAO_REDIRECT_URI" >> .env
          echo "EMAIL_USERNAME= $EMAIL_USERNAME" >> .env
          echo "EMAIL_PASSWORD= $EMAIL_PASSWORD" >> .env
          echo "$FIREBASE_PRIVATE_KEY" >> ./src/main/resources/firebase-private-key.json
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DLL_MODE: ${{ secrets.DB_DLL_MODE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_CLIENT_SECRET : ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_OAUTH_CLIENT_ID : ${{ secrets.KAKAO_OAUTH_CLIENT_ID }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
          FIREBASE_PRIVATE_KEY : ${{ secrets.FIREBASE_PRIVATE_KEY }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_USERNAME: ${{ secrets.EMAIL_USERNAME }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name : Discord Build Alarm when fail
        uses : sarisia/actions-status-discord@v1
        if : failure()
        with :
          webhook: ${{ secrets.DISCORD_BE_WEB_HOOK_URL }}
          status: ${{ job.status }}
          title: "build"
          color: 0xff0000
          username: Github Actions

      - name : Discord Build Alarm when success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_BE_WEB_HOOK_URL }}
          status: ${{ job.status }}
          title: "build"
          color: 0x00ff00
          username: Github Actions

      - name : Test
        run: ./gradlew test

      - name: Discord Test Alarm when fail
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_BE_WEB_HOOK_URL }}
          status: ${{ job.status }}
          title: "test"
          description: "test fail"
          color: 0xff0000
          username: Github Actions

      - name: Discord Test Alarm when success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_BE_WEB_HOOK_URL }}
          status: ${{ job.status }}
          title: "test"
          description: "test success"
          color: 0x00ff00
          username: Github Actions
